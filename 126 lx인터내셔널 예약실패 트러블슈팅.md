# 1/26 lx인터내셔널 예약실패 트러블슈팅

1/26 lx인터내셔널 예약실패 접수

현상을 확인한 결과 예약 api를 호출할 때만 에러 발생

- 클라이언트에서 받은 response가 200 OK지만 body가 null임

- 예약 api가 아닌 전단계의 로그인, 스케줄조회 등의 단계는 모두 성공



응용레벨(Spring boot, tomcat WAS)에서 web로그를 남기고 있지 않아서 request내용을 찾을 수 없음

lx인터내셔널에서 예약성공한 최신 날짜는 1/18, 최근 obt운영반영일은 1/13



## api의 문제? (응용레벨 에러)

예약 실패한 유저와 항공스케쥴을 알아내 최대한 동일한 요청을 만들어서 api테스트를 함. 모두 성공

고객사가 접속하는 인터페이스 환경 문제일까 싶어서 실제 고객정보로 btms인터페이스 접속해서 테스트, api직접 호출해서 테스트 다 성공



## 인증 방법의 문제?

jeus서버 access로그를 확인한 결과 에러 발생한 요청에 대해 모두 401 응답을 한 것으로 확인

예약 전단계 api호출에는 이상없다가, 예약api 호출만 하면 인증에 문제가 생기는지 의문, 인증 과정을 검토함

1. btms와 약속한 형식의 get요청으로 토큰을 발급하고 redirect url을 받아서 서비스에 접속 
2. 첫 로그인시 btms토큰을 obt에 접속하면서 obt검증 프로세스 시작
   - rtis br을 호출해서 토큰에 맞는 유저정보를 가져옴 (mongoDB에 들어있다)
   - 정보를 정상적으로 가져오면 redis db에 저장해서 다음 요청부터는 redis에서 꺼내서 사용함. 
   - <strong>현재 문제와는 무관하지만</strong> 지금 방식은 redis expire time까지 접속해 있으면 그후 인증실패가 발생하는 것을 확인. 인증 실패 후 redis 재등록 등의 로직이 존재하지 않음. 현재 expire time이 1시간이므로 1시간동안 접속한 유저는 무조건 인증에러발생함.

예약 api를 호출 할 때 인증토큰을 누락하면 설명 가능한 현상이지만, 웹에서 인증토큰만 빼고 요청을 보낼 수 있는 가능성이 보이지 않음

그러면 왜 401에러가 발생했을지 고민



## 네트워크의 문제?

다른 고객사는 해당 이슈가 없는 것으로 보아, lx인터내셔널과 연결된 네트워크 문제가 의심

그러면 다른 api는 성공하고 예약api만 실패하는가? 예약 api가 가지는 차이점을 분석함

1. request body의 사이즈가 상당히 크다 (수십 KB). 일정 사이즈 이상의 request를 누락시키는 서버 설정이 존재 할 수 있을까?
2. api의 수행시간이 매우 길다 (평균 8초). 서버에서 타임아웃이 발생할 수 있을까? 만약 타임아웃이라면 401에러로 응답한 것이 가능한가?
3. 예약자 휴대폰 번호, 카드번호 등 개인정보를 body에 포함함. 네트워크 보안에서 이런 요청을 사전에 차단할 수 있을까?

네트워크 문제를 의심하고, 여러 케이스를 테스트해봄. 만약 body가 누락되어서 요청이 오면 해당 현상이 동일하게 발생하는 것이 확인. <strong>문제와는 무관하지만</strong> api에서는 401 status로 응답했는데 왜 크롬 브라우저 네트워크탭으로 확인하면 200 OK로 나올까? api를 postman으로 직접 호출했을 때는 401로 응답받는 것을 확인. 웹서버로 jeus webtob를 사용하는데 webtob <-> was server 간 어떤 설정이 존재하는가?



1/28 lx인터내셔널에 직접 방문해서 현상을 확인하기로 함

방문하기 전 was에 들어온 request를 확인하기 위해 예약api url로 들어온 요청에 대해서만 개발서버에서 로그를 남김. 로깅 filter클래스를 만들고 FilterRegistrationBean으로 등록



## 고객사 방문 확인 (1/28)

1/28 lx인터내셔널에 방문함. 고객사 pc로 btms-obt접속해서 예약오류 나는 현상 직접 확인.

특이사항으로 최근 Singlex UAS도입을 했다고 함. btms접속하는데 네트워크단계가 하나 더 추가된 것이므로 (lx 인터넷망 - singlex클라우드) 네트워크단 의심이 더 커짐.

고객사 pc로 btms개발서버에 접속해서 테스트. 동일하게 예약api호출할 떄만 에러발생. 크롬 개발자도구로 확인한 결과 브라우저에서는 제대로 request를 만들어서 보냄. was로그를 확인하니까 요청이 들어왔는데, body만 로그에 찍히지 않는 것을 확인. 어떤 문제로 body가 누락되거나 인지 할 수 없다는 결론을 내리고, 네트워크 또는 보안환경을 확인할 수 없으니 일단 복귀.

확인한 현상 : request body 누락

강한 의심 : 예약 api는 민감한 개인정보 패턴을 포함해서 보내므로, 어디선가 네트워크상 보안툴에서 잡아서 누락했을 것이다. 최근 singlex를 도입했으므로 마지막 예약성공일인 18일 이후인지는 모르겠으나, 강하게 의심이 감.

lx인터내셔널 인터넷망, singlex 클라우드망, 레드캡 인터넷망 3가지를 검증해보고 싶어짐



## 고객사에 추가 확인 사항 요청 (2/7)

휴가 복귀 후 2/7 추가 확인 사항을 정리해서 고객사에 요청함.

1/28 방문했을 때 singlex 개발 서버 접속 url과 계정정보를 1차적으로 요청(singlex 네트워크 확인용).  고객사 방문했을 때 명함을 받은 분에게 문자로 요청했으나 2/9 현재까지 답장없음. 문자로 보내면 안되나?

레드캡과 회의를 통해 현상을 설명함. 필요사항을 재정리해서 레드캡직원분을 통해 메일로 다시 요청함

1. 1/28 방문 했을 때, singlex 개발 서버 접속에 사용한 url과 계정정보 (직접 테스트 해보기 위해, singlex 네트워크 검증)

2. LX인터넷망에서 https://tst-btms4.redcap.co.kr/landingLegacy?cust_cd=LIC&encrypt_id=3c4b8b41a9&id=2080025 로 직접 접속해서 항공 예약이 성공하는지 여부 (lx인터내셔널 인터넷만을 통해 btms접속 함으로써 lx 네트워크 검증)

3. singlex가 도입된 시기 (마지막 예약성공인 18일 이후인가 확인)

2/9 현재 답장없음



만약 답이 온 경우 테스트를 어떻게 할까 고민

was로그에 의존하는 것은 확실하지 못하다고 생각. 스프링에 만든 로그필터에 도달하기 전 거치는 필터들이 많기 때문

tcpdump로 post요청을 모니터링할려고 시도. ex) tcpdump -i ens192 -s 0 -A 'tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x504F5354'

확인 결과 외부에서는 btms로 요청하므로 btms를 향한 tcp로그만 찍힘. 필요한 것은 btms -> obt요청이므로 확인 불가능. was에서 직접 로그를 찍을 수 밖에 없다.



-> 여기서부터 엄청난 뻘짓. 2/8 레드캡 팀장님이 lx보안팀과 직접 연락해 현상 설명 후, 보안팀에서 레드캡 ip 바이패스 시키면서 문제해결  . 아마 singlex 설정 수정한듯. 해당 내용 당연히 전달받지 못함

## lx인터내셔널 예약성공 (2/8)

혼자 로그를 찾아보다가 2/8 14시 17분 lx인터내셔널에서 예약이 하나 성공한 것을 확인. access로그 확인하니 1/18 이후 계속 예약이 실패한 ip와 동일함.

그동안 예약이 안되었다가 조치한 것이 없는데 갑자기 예약이 성공했기 때문에, 레드캡 시스템의 문제라고 생각함.

예약 api가 있는 obt시스템은 jeus서버 2개로 나뉘어져 있음. 로그를 확인해보니 1번서버로 붙어서 예약에 성공함.

### WAS가 올라가 있는 1번, 2번서버 차이로 발생한 문제?

1. 2번서버에 문제가 있나? -> 직접 2번에만 붙여서 테스트한 결과 문제없음
2. 2번서버에서 붙는 db에 문제가 있나? -> db만 바꿔가면서 테스트한 결과 문제없음
3. LB가 서버를 바꾸면 문제가 발생하나? stateless하지 못한가? -> 1번으로 항공조회, 2번으로 예약했으나 문제없음

### webtob -> was 연결간 문제?

webtob 연결 설정에 문제가 발생했나? jeus webtob 매뉴얼을 참고해 config파일 발견. http.m_B2B에 설정정보를 쓰고, wsconfig이름의 바이너리 파일로 변환하면 적용됨.

마지막 변경일이 1/19 인 것을 확인. 최신 백업본과 비교해보니 btms로 보내는 Options method설정변경(정확히 어떻게 변경된 것인지는 모르겠음), chatbot proxy 설정 추가 된 것 같음 (btms에 올라가서 실행되는데, CORS를 피하기 위해 proxy설정을 했나봄).

이런 설정 변경이 영항을 미쳤을까?



2/9 출근 후 2/8일 이미 조치했다는 내용 전달받고 마무리





